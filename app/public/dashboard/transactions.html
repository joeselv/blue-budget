<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueBudget - Transactions</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,200,0..1,0" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css"> 
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <img src="../../resources/blueBudgetLogo.svg" alt="BlueBudget Logo" class="logo-img">
            BlueBudget
        </div>

        <a href="budget" id="budget" class="menu-item">
            <span class="material-symbols-rounded">savings</span>
            <span>Budget</span>
        </a>
        <a href="transactions" id="transactions" class="menu-item selected">
            <span class="material-symbols-rounded">receipt_long</span>
            <span>Transactions</span>
        </a>
        <a href="accounts" id="accounts" class="menu-item">
            <span class="material-symbols-rounded">person</span>
            <span>Accounts</span>
        </a>
        <a href="settings" id="settings" class="menu-item">
            <span class="material-symbols-rounded">settings</span>
            <span>Settings</span>
        </a>
    </div>

    <div class="main-container">
        <div class="header">
            <p class="page-title">Transactions</p>
            <button id="logout-btn" class="logout-btn">Log Out</button>
        </div>

        <div class="content">
            <div class="main-content">
                <div class="actions-bar">
                    <input type="text" id="searchBar" placeholder="Search Transactions...">
                    <button class="edit-category-btn" onclick="openPopup()">Add Transaction</button>
                </div>
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="transaction_id" data-type="number">
                                Transaction ID
                                <span class="arrows">
                                    <span class="arrow asc-arrow">▲</span>
                                    <span class="arrow desc-arrow">▼</span>
                                </span>
                            </th>
                            <th class="sortable" data-column="account_type" data-type="text">
                                Account Type
                                <span class="arrows">
                                    <span class="arrow asc-arrow">▲</span>
                                    <span class="arrow desc-arrow">▼</span>
                                </span>
                            </th>
                            <th class="sortable" data-column="category_name" data-type="text">
                                Category
                                <span class="arrows">
                                    <span class="arrow asc-arrow">▲</span>
                                    <span class="arrow desc-arrow">▼</span>
                                </span>
                            </th>
                            <th class="sortable" data-column="transaction_date" data-type="date">
                                Transaction Date
                                <span class="arrows">
                                    <span class="arrow asc-arrow">▲</span>
                                    <span class="arrow desc-arrow">▼</span>
                                </span>
                            </th>
                            <th class="sortable" data-column="amount" data-type="number">
                                Amount
                                <span class="arrows">
                                    <span class="arrow asc-arrow">▲</span>
                                    <span class="arrow desc-arrow">▼</span>
                                </span>
                            </th>
                            <th class="sortable" data-column="transaction_type" data-type="text">
                                Transaction Type
                                <span class="arrows">
                                    <span class="arrow asc-arrow">▲</span>
                                    <span class="arrow desc-arrow">▼</span>
                                </span>
                            </th>
                            <th class="sortable" data-column="merchant_name" data-type="text">
                                Transaction Description
                                <span class="arrows">
                                    <span class="arrow asc-arrow">▲</span>
                                    <span class="arrow desc-arrow">▼</span>
                                </span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <!-- Table rows will be dynamically generated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="popup-overlay" id="popup-overlay">
        <div class="popup-content">
            <h2>Add New Transaction</h2>
    
            <label for="transaction-name">Merchant Name</label>
            <input type="text" id="transaction-name" placeholder="Enter merchant name">
    
            <label for="transaction-amount">Amount</label>
            <input type="number" id="transaction-amount" placeholder="Enter amount">
    
            <label for="transaction-date">Transaction Date</label>
            <input type="date" id="transaction-date">
    
            <label for="transaction-type">Transaction Type</label>
            <select id="transaction-type">
                <option value="Expense">Expense</option>
                <option value="Income">Income</option>
            </select>
    
            <label for="transaction-description">Description</label>
            <input type="text" id="transaction-description" placeholder="Enter description">
    
            <label for="transaction-category">Category</label>
            <select id="transaction-category">
                <option value="">Loading...</option>
            </select>
    
            <div class="popup-buttons">
                <button onclick="closePopup()">Cancel</button>
                <button onclick="saveTransaction()" class="confirm-btn">Save</button>
            </div>
        </div>
    </div>

    <script>
        const menuItems = document.querySelectorAll('.menu-item');
        
        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                menuItems.forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
        
                const pageTitle = document.querySelector('.page-title');
                const pageName = item.querySelector('span:last-child').textContent;
                pageTitle.textContent = pageName;
            });
        });

        // Logout button event listener
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/logout', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/'; 
                } else {
                    alert("Failed to log out. Please try again.");
                }
            } catch (error) {
                console.error("Logout error:", error);
                alert("An error occurred while logging out.");
            }
        });

        function openPopup() {
            const overlay = document.getElementById('popup-overlay');
            overlay.style.visibility = 'visible';
            overlay.style.opacity = '1';

            // Fetch categories when the popup opens
            fetchCategories();
        }

        async function fetchCategories() {
            const categorySelect = document.getElementById('transaction-category');
            try {
                const response = await fetch('/categories?userID=1&budgetID=1');
                if (!response.ok) {
                    throw new Error('Failed to fetch categories');
                }
                const categories = await response.json();
                categorySelect.innerHTML = ''; // Clear existing options
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.category_id;
                    option.textContent = category.category_name;

                    // Add a custom data attribute for the icon URL
                    option.setAttribute(
                        'data-icon',
                        `/resources/categoryIcons/${category.icon_name}`
                    );

                    categorySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching categories:', error);
                categorySelect.innerHTML = '<option value="">Error loading categories</option>';
            }
        }

        function closePopup() {
            const overlay = document.getElementById('popup-overlay');
            overlay.style.visibility = 'hidden';
            overlay.style.opacity = '0';
            document.getElementById('transaction-category').value = '';
            document.getElementById('transaction-description').value = '';
            document.getElementById('transaction-type').value = '';
            document.getElementById('transaction-date').value = '';
            document.getElementById('transaction-amount').value = '';
            document.getElementById('transaction-name').value = '';
        }

        async function saveTransaction() {
            const merchantName = document.getElementById('transaction-name').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const transactionDate = document.getElementById('transaction-date').value;
            const transactionType = document.getElementById('transaction-type').value;
            const transactionDescription = document.getElementById('transaction-description').value;
            const categoryId = document.getElementById('transaction-category').value;
            const accountId = 4; // Hardcoded value

            if (!merchantName || !amount || !transactionDate || !transactionType || !categoryId) {
                alert('Please fill out all required fields.');
                return;
            }

            try {
                const response = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        merchant_name: merchantName,
                        amount,
                        transaction_date: transactionDate,
                        transaction_type: transactionType,
                        transaction_description: transactionDescription,
                        account_id: accountId,
                        category_id: categoryId
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save transaction');
                }

                alert('Transaction saved successfully!');
                closePopup();
                // Optionally, refresh the table or fetch updated transactions
            } catch (error) {
                console.error('Error saving transaction:', error);
                alert('Error saving transaction.');
            }
        }



        document.addEventListener('DOMContentLoaded', async () => {
            const tableBody = document.getElementById('transactionsTableBody');
            const searchBar = document.getElementById('searchBar');
            let transactions = [];
            let categories = [];

            const userID = "1"; // Replace with actual userID
            const budgetID = "1"; // Replace with actual budgetID

            async function fetchCategories() {
                try {
                    const response = await fetch(`/categories?userID=${userID}&budgetID=${budgetID}`);
                    if (!response.ok) throw new Error('Failed to fetch categories');
                    categories = await response.json();
                } catch (error) {
                    console.error('Error fetching categories:', error);
                    alert('Failed to load categories. Please try again.');
                }
            }

            async function fetchTransactions() {
                try {
                    const response = await fetch(`/api/transactions?timestamp=${Date.now()}`);
                    if (!response.ok) throw new Error('Failed to fetch transactions');
                    transactions = await response.json();
                    renderTable(transactions);
                } catch (error) {
                    console.error('Error fetching transactions:', error);
                    alert('Failed to load transactions. Please try again.');
                }
            }

            function renderTable(data) {
                tableBody.innerHTML = ''; // Clear existing rows

                data.forEach(transaction => {
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td>${transaction.transaction_id}</td>
                        <td>${transaction.account_type}</td>
                        <td class ="category-cell">
                            <span>${transaction.category_name || 'Uncategorized'}</span>
                            <button class="table-btn edit-btn">
                                <span class="material-symbols-rounded">edit</span>Edit
                            </button>
                        </td>
                        <td>${new Intl.DateTimeFormat('en-CA').format(new Date(transaction.transaction_date))}</td>
                        <td class="${transaction.amount < 0 ? 'negative' : 'positive'}">${transaction.amount}</td>
                        <td>${transaction.transaction_type}</td>
                        <td>${transaction.merchant_name}</td>
                    `;

                    const categoryCell = row.children[2];
                    const editButton = categoryCell.querySelector('.edit-btn');

                    editButton.addEventListener('click', () => {
                        const currentCategory = categoryCell.querySelector('span').textContent;

                        categoryCell.innerHTML = `
                            <select>
                                ${categories.map(category => `
                                    <option value="${category.category_id}" ${category.category_name === currentCategory ? 'selected' : ''}>
                                        ${category.category_name}
                                    </option>
                                `).join('')}
                            </select>
                            <button class="table-btn save">
                                <span class="material-symbols-rounded">save</span>Save
                            </button>
                        `;

                        const saveButton = categoryCell.querySelector('.save');
                        saveButton.addEventListener('click', async () => {
                            const newCategoryId = categoryCell.querySelector('select').value;

                            try {
                                const updateResponse = await fetch('/api/update-category', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        transactionId: transaction.transaction_id,
                                        categoryId: newCategoryId
                                    })
                                });

                                if (!updateResponse.ok) throw new Error('Failed to update transaction category');

                                const updatedCategoryName = categories.find(cat => cat.category_id === parseInt(newCategoryId)).category_name;

                                categoryCell.innerHTML = `
                                    <span>${updatedCategoryName}</span>
                                    <button class="table-btn edit-btn">
                                        <span class="material-symbols-rounded">edit</span>Edit
                                    </button>
                                `;
                            } catch (error) {
                                console.error('Error updating transaction category:', error);
                                alert('Failed to update category. Please try again.');
                            }
                        });
                    });


                    
                    tableBody.appendChild(row);
                });
            }
             // Sorting logic
             function sortTable(column, type) {
                const ascending = !document.querySelector(`th[data-column="${column}"]`).classList.contains('asc');

                // Reset all column headers
                document.querySelectorAll('th').forEach(th => th.classList.remove('asc', 'desc'));

                // Add appropriate sorting class to the clicked column header
                const columnHeader = document.querySelector(`th[data-column="${column}"]`);
                columnHeader.classList.add(ascending ? 'asc' : 'desc');

        
                const sortedData = [...transactions].sort((a, b) => {
                    // Handle column value retrieval
                    let valA = a[column];
                    let valB = b[column];

                    // Special case for category_name: prioritize null or missing category_id
                    if (column === 'category_name') {
                        const hasCategoryA = a.category_name !== null && a.category_name !== undefined;
                        const hasCategoryB = b.category_name !== null && b.category_name !== undefined;
                        console.log('travel' > 'eating out');
                        // Prioritize rows with no category_id (null or undefined)
                        if (!hasCategoryA && hasCategoryB) return ascending ? 1 : -1;
                        if (!hasCategoryB && hasCategoryA) return ascending ? -1 : 1;

                         // If both have category_id, sort alphabetically by category_name
                         if (hasCategoryA && hasCategoryB) {
                            const charA = String(a.category_name || '').charAt(0).toLowerCase();
                            const charB = String(b.category_name || '').charAt(0).toLowerCase();
                            console.log(ascending, charA, charB, charA > charB);
                            if (ascending) {
                                return charA > charB ? 1 : -1;
                            } else {
                                return charA < charB ? -1 : 1;
                            }
                        }
                    }
                
                    // General sorting logic
                    if (type === 'number') {
                        valA = parseFloat(valA) || 0;
                        valB = parseFloat(valB) || 0;
                    } else if (type === 'date') {
                        valA = new Date(valA).getTime();
                        valB = new Date(valB).getTime();
                    } else {
                        valA = String(valA || '').charAt(0).toLowerCase();
                        valB = String(valB || '').charAt(0).toLowerCase();
                    }
                    console.log(typeof valA, typeof valB);
                    // Ascending or descending comparison
                    if (ascending) {
                        return valA > valB ? 1 : -1;
                    } else {
                        return valA < valB ? 1 : -1;
                    }
                });
                renderTable(sortedData);
            }

            // Add event listeners to sortable column headers
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.column;
                    const type = column == 'amount' ? 'number' : header.dataset.type;
                    sortTable(column, type);
                });
            });

            await fetchCategories();
            await fetchTransactions();
        });
    </script>
</body>
</html>
